<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Print Room — Partner Ledger (Firebase)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { theme: { extend: { colors: { base: { bg:'#0f1628', card:'#18223c', ink:'#eef1ff', line:'#2a3357', acc:'#6c85ff' }}}}};
</script>
<style>
  body{background:#0f1628;color:#eef1ff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .card{background:#18223c;border:1px solid #2a3357;border-radius:16px}
  .chip{border:1px solid #2a3357}
  .input{background:transparent;border:1px solid #2a3357;border-radius:12px;padding:.75rem}
  .btn{background:#6c85ff;color:#000;font-weight:600;border-radius:12px;padding:.75rem 1rem}
  .btn.ghost{background:transparent;border:1px solid #2a3357;color:#eef1ff}
  table{border-collapse:separate;border-spacing:0}
  th,td{border-bottom:1px solid #2a3357}
  tr:last-child td{border-bottom:none}
  .hidden{display:none}
</style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-30 backdrop-blur bg-black/20 border-b border-[#2a3357]">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-[#6c85ff]/20 grid place-items-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16M4 12h10M4 17h16" stroke="#9db0ff" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
        <div>
          <div class="font-bold">The Print Room — Partner Ledger</div>
          <div class="text-xs text-white/60">Two-way split tracker for Ranveer & Aman</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="whoami" class="text-xs text-white/70 hidden"></span>
        <button id="exportCsv" class="btn ghost hidden">Export CSV</button>
        <button id="logoutBtn" class="btn ghost hidden">Logout</button>
      </div>
    </div>
  </header>

  <!-- Auth Screen -->
  <section id="authScreen" class="max-w-md mx-auto p-6 mt-10 card">
    <h2 class="text-xl font-bold">Sign in</h2>
    <p class="text-sm text-white/70 mt-1">Only partners with accounts can access the ledger.</p>
    <form id="loginForm" class="grid gap-3 mt-4">
      <div class="grid gap-1">
        <label class="text-xs text-white/70">Email</label>
        <input id="email" type="email" class="input" placeholder="you@example.com" required autofocus />
      </div>
      <div class="grid gap-1">
        <label class="text-xs text-white/70">Password</label>
        <input id="password" type="password" class="input" placeholder="••••••••" required />
      </div>
      <button class="btn" type="submit">Sign in</button>
      <button id="resetBtn" class="btn ghost" type="button">Send password reset</button>
      <div id="authMsg" class="text-sm text-white/70"></div>
    </form>
  </section>

  <!-- App Screen -->
  <main id="appScreen" class="max-w-7xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6 hidden">
    <!-- Left: Add / Balance -->
    <section class="lg:col-span-1 space-y-6">
      <div class="card p-5">
        <h2 class="text-lg font-bold">Add entry</h2>
        <p class="text-sm text-white/70">Add every business expense or sale. The math splits 50/50 automatically.</p>
        <form id="entryForm" class="mt-4 grid gap-3">
          <div class="grid gap-1">
            <label class="text-xs text-white/70">Type</label>
            <select id="type" class="input" required>
              <option value="expense">Expense / Purchase</option>
              <option value="sale">Sale / Payment received</option>
            </select>
          </div>
          <div class="grid gap-1">
            <label class="text-xs text-white/70">Who made it</label>
            <select id="by" class="input" required>
              <option value="Ranveer">Ranveer</option>
              <option value="Aman">Aman</option>
            </select>
          </div>
          <div class="grid gap-1">
            <label class="text-xs text-white/70">Amount (CAD)</label>
            <input id="amount" type="number" step="0.01" min="0" class="input" placeholder="100" required />
          </div>
          <div class="grid gap-1">
            <label class="text-xs text-white/70">Sold to / Bought from</label>
            <input id="party" class="input" placeholder="Client or supplier name" />
          </div>
          <div class="grid gap-1">
            <label class="text-xs text-white/70">Date</label>
            <input id="date" type="date" class="input" />
          </div>
          <div class="grid gap-1">
            <label class="text-xs text-white/70">Notes</label>
            <textarea id="notes" class="input" rows="2" placeholder="Paper stock, job id, etc."></textarea>
          </div>
          <button class="btn" type="submit">Save entry</button>
          <div id="formMsg" class="text-sm text-white/70"></div>
        </form>
      </div>

      <div class="card p-5">
        <h2 class="text-lg font-bold">Settlement</h2>
        <p class="text-sm text-white/70">Net balance considering halves of every expense and sale.</p>
        <div id="settlementBox" class="mt-4 text-xl font-bold"></div>
        <div id="totals" class="mt-3 text-sm text-white/70"></div>
      </div>

      <div class="card p-5">
        <h2 class="text-lg font-bold">Last 10 entries</h2>
        <ul id="last10" class="mt-3 grid gap-2 text-sm"></ul>
      </div>
    </section>

    <!-- Right: Table -->
    <section class="lg:col-span-2 card p-5">
      <div class="flex flex-wrap items-center gap-2">
        <h2 class="text-lg font-bold mr-auto">All entries</h2>
        <select id="filterRange" class="input">
          <option value="life">All time</option>
          <option value="week">This week</option>
          <option value="month">This month</option>
          <option value="year">This year</option>
        </select>
        <input id="searchBox" class="input" placeholder="Search name, notes…" />
      </div>
      <div class="overflow-auto mt-4">
        <table class="w-full text-sm">
          <thead class="text-white/60">
            <tr>
              <th class="text-left p-2">Date</th>
              <th class="text-left p-2">Type</th>
              <th class="text-left p-2">By</th>
              <th class="text-right p-2">Amount</th>
              <th class="text-left p-2">Party</th>
              <th class="text-left p-2">Notes</th>
              <th class="text-left p-2">Added by</th>
              <th class="text-right p-2">Owes Half</th>
              <th class="text-right p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="mt-3 text-xs text-white/60">Rule: Expense by X means the other owes X half. Sale by X means X owes the other half.</div>
    </section>
  </main>

  <!-- Edit Modal -->
  <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
    <div class="card p-5 w-full max-w-lg">
      <div class="flex items-center justify-between">
        <h3 class="font-bold">Edit entry</h3>
        <button id="closeModal" class="btn ghost">Close</button>
      </div>
      <form id="editForm" class="mt-4 grid gap-3">
        <input type="hidden" id="editId" />
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Type</label>
          <select id="editType" class="input" required>
            <option value="expense">Expense / Purchase</option>
            <option value="sale">Sale / Payment received</option>
          </select>
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Who made it</label>
          <select id="editBy" class="input" required>
            <option value="Ranveer">Ranveer</option>
            <option value="Aman">Aman</option>
          </select>
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Amount (CAD)</label>
          <input id="editAmount" type="number" step="0.01" min="0" class="input" required />
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Sold to / Bought from</label>
          <input id="editParty" class="input" />
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Date</label>
          <input id="editDate" type="date" class="input" />
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Notes</label>
          <textarea id="editNotes" class="input" rows="2"></textarea>
        </div>
        <div class="flex items-center gap-2">
          <button class="btn" type="submit">Save changes</button>
          <button id="deleteEntry" type="button" class="btn ghost">Delete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    // Firebase v9+ modular from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // --- Your config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBALPTzgm1uiVCW4bwMJC2TPrWSsF-cCwQ",
      authDomain: "theprintroomlondon-6f586.firebaseapp.com",
      projectId: "theprintroomlondon-6f586",
      storageBucket: "theprintroomlondon-6f586.firebasestorage.app",
      messagingSenderId: "397446046987",
      appId: "1:397446046987:web:d9efe75b09d82ad6072e0e",
      measurementId: "G-D2Z6XF06Q6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // cache offline
    try { await enableIndexedDbPersistence(db); } catch(e) { /* ignore */ }

    // UI refs
    const whoami = document.getElementById('whoami');
    const authScreen = document.getElementById('authScreen');
    const appScreen = document.getElementById('appScreen');
    const loginForm = document.getElementById('loginForm');
    const authMsg = document.getElementById('authMsg');
    const resetBtn = document.getElementById('resetBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const exportCsv = document.getElementById('exportCsv');

    const entryForm = document.getElementById('entryForm');
    const formMsg = document.getElementById('formMsg');
    const filterRange = document.getElementById('filterRange');
    const searchBox = document.getElementById('searchBox');
    const tableBody = document.getElementById('tableBody');
    const last10El = document.getElementById('last10');

    const modal = document.getElementById('modal');
    const closeModalBtn = document.getElementById('closeModal');
    const editForm = document.getElementById('editForm');

    const fmt = (n)=> Number(n).toLocaleString(undefined,{style:'currency',currency:'CAD'});
    const todayISO = ()=> new Date().toISOString().slice(0,10);

    let unsubscribe = null;
    let cache = [];

    function showApp(show){
      authScreen.classList.toggle('hidden', show);
      appScreen.classList.toggle('hidden', !show);
      logoutBtn.classList.toggle('hidden', !show);
      exportCsv.classList.toggle('hidden', !show);
      whoami.classList.toggle('hidden', !show);
    }

    onAuthStateChanged(auth, user => {
      if(user){
        whoami.textContent = `Signed in as ${user.email}`;
        showApp(true);
        attachListener();
      } else {
        showApp(false);
        if(unsubscribe){ unsubscribe(); unsubscribe = null; }
      }
    });

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      authMsg.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try{
        await signInWithEmailAndPassword(auth, email, password);
      } catch(err){ authMsg.textContent = err.message; }
    });

    resetBtn.addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      if(!email){ authMsg.textContent = 'Enter your email first.'; return; }
      try{ await sendPasswordResetEmail(auth, email); authMsg.textContent = 'Reset link sent.'; }
      catch(err){ authMsg.textContent = err.message; }
    });

    logoutBtn.addEventListener('click', ()=> signOut(auth));

    // Firestore
    const entriesCol = collection(db, 'entries');

    function attachListener(){
      if(unsubscribe) unsubscribe();
      // Single orderBy to avoid composite index requirement
      const q = query(entriesCol, orderBy('createdAt','desc'));
      unsubscribe = onSnapshot(q, snap => {
        cache = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        render();
      }, err => {
        console.error('Listener error:', err);
      });
    }

    // Create entry
    entryForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const user = auth.currentUser;
      const rawDate = document.getElementById('date').value || todayISO();
      const entry = {
        type: document.getElementById('type').value,
        by: document.getElementById('by').value,
        amount: parseFloat(document.getElementById('amount').value||'0'),
        party: document.getElementById('party').value.trim(),
        date: rawDate,
        notes: document.getElementById('notes').value.trim(),
        createdAt: serverTimestamp(),
        dateTS: new Date(rawDate),
        createdByEmail: user?.email || 'unknown',
        createdByUid: user?.uid || null
      };
      if(!(entry.amount>0)) { formMsg.textContent = 'Enter a valid amount.'; return; }
      try{
        await addDoc(entriesCol, entry);
        entryForm.reset();
        document.getElementById('date').value = todayISO();
        formMsg.textContent = 'Saved.';
      } catch(err){ formMsg.textContent = err.message; }
    });

    filterRange.addEventListener('change', render);
    searchBox.addEventListener('input', render);

    function asDate(val){
      if(!val) return new Date(0);
      // Firestore Timestamp
      if(val.seconds && typeof val.seconds === 'number'){ return new Date(val.seconds*1000); }
      // JS Date
      if(val instanceof Date){ return new Date(val.getTime()); }
      // ISO string
      return new Date(val);
    }

    function compute(entries){
      let balance=0, expR=0, expA=0, saleR=0, saleA=0;
      for(const e of entries){
        const half = e.amount/2;
        if(e.type==='expense'){
          if(e.by==='Ranveer'){ balance += half; expR += e.amount; }
          else { balance -= half; expA += e.amount; }
        } else if(e.type==='sale'){
          if(e.by==='Ranveer'){ balance -= half; saleR += e.amount; }
          else { balance += half; saleA += e.amount; }
        }
      }
      return { balance, expR, expA, saleR, saleA };
    }

    function applyFilters(list){
      const range = filterRange.value;
      const search = searchBox.value.toLowerCase();
      const now = new Date();
      const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - now.getDay());
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const startOfYear = new Date(now.getFullYear(), 0, 1);

      return list.filter(e=>{
        const d = asDate(e.dateTS || e.date);
        if(range==='week' && d < startOfWeek) return false;
        if(range==='month' && d < startOfMonth) return false;
        if(range==='year' && d < startOfYear) return false;
        const blob = `${e.type} ${e.by} ${e.party||''} ${e.notes||''} ${e.createdByEmail||''}`.toLowerCase();
        if(search && !blob.includes(search)) return false;
        return true;
      });
    }

    function render(){
      const sorted = cache.slice().sort((a,b)=> asDate(b.dateTS||b.date) - asDate(a.dateTS||a.date));
      const entries = applyFilters(sorted);

      const { balance, expR, expA, saleR, saleA } = compute(entries);
      const sBox = document.getElementById('settlementBox');
      if(balance > 0) sBox.textContent = `Aman owes Ranveer ${fmt(balance)}`;
      else if(balance < 0) sBox.textContent = `Ranveer owes Aman ${fmt(Math.abs(balance))}`;
      else sBox.textContent = 'You are square. 0.00 CAD';
      document.getElementById('totals').innerHTML = `
        <div>Total expenses — Ranveer: <b>${fmt(expR)}</b>, Aman: <b>${fmt(expA)}</b></div>
        <div>Total sales — Ranveer: <b>${fmt(saleR)}</b>, Aman: <b>${fmt(saleA)}</b></div>
        <div>Entries shown: <b>${entries.length}</b> of ${cache.length}</div>`;

      const last10 = sorted.slice(0,10);
      last10El.innerHTML = last10.map(e=>{
        const d = asDate(e.dateTS || e.date);
        const dateStr = isNaN(d) ? (e.date || '') : d.toISOString().slice(0,10);
        return `<li class="chip rounded-xl px-3 py-2">
          <span class="text-white/70">${dateStr}</span>
          <span class="mx-2">•</span>
          <span class="${e.type==='expense'?'text-red-300':'text-green-300'} font-semibold">${e.type}</span>
          <span class="mx-1 text-white/70">by</span>
          <span class="font-semibold">${e.by}</span>
          <span class="mx-2">•</span>
          <span>${fmt(e.amount)}</span>
          <span class="mx-2">•</span>
          <span class="text-white/70">added by ${e.createdByEmail||'unknown'}</span>
        </li>`;
      }).join('');

      tableBody.innerHTML = entries.map(e=>{
        const d = asDate(e.dateTS || e.date);
        const dateStr = isNaN(d) ? (e.date || '') : d.toISOString().slice(0,10);
        const half = e.amount/2;
        const owes = e.type==='expense'
          ? (e.by==='Ranveer' ? `Aman → ${fmt(half)}` : `Ranveer → ${fmt(half)}`)
          : (e.by==='Ranveer' ? `Ranveer → ${fmt(half)}` : `Aman → ${fmt(half)}`);
        return `<tr>
          <td class="p-2">${dateStr}</td>
          <td class="p-2 ${e.type==='expense'?'text-red-300':'text-green-300'}">${e.type}</td>
          <td class="p-2">${e.by}</td>
          <td class="p-2 text-right">${fmt(e.amount)}</td>
          <td class="p-2">${e.party||''}</td>
          <td class="p-2">${e.notes||''}</td>
          <td class="p-2">${e.createdByEmail||''}</td>
          <td class="p-2 text-right">${owes}</td>
          <td class="p-2 text-right"><button class="link" data-id="${e.id}" data-action="edit">Edit</button></td>
        </tr>`;
      }).join('');
    }

    tableBody.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="edit"]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const e = cache.find(x=>x.id===id);
      if(!e) return;
      document.getElementById('editId').value = e.id;
      document.getElementById('editType').value = e.type;
      document.getElementById('editBy').value = e.by;
      document.getElementById('editAmount').value = e.amount;
      document.getElementById('editParty').value = e.party||'';
      const d = asDate(e.dateTS || e.date);
      document.getElementById('editDate').value = isNaN(d) ? (e.date || '') : d.toISOString().slice(0,10);
      document.getElementById('editNotes').value = e.notes||'';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    closeModalBtn.addEventListener('click', ()=>{ modal.classList.add('hidden'); modal.classList.remove('flex'); });

    editForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const id = document.getElementById('editId').value;
      const ref = doc(db, 'entries', id);
      const rawDate = document.getElementById('editDate').value || todayISO();
      const payload = {
        type: document.getElementById('editType').value,
        by: document.getElementById('editBy').value,
        amount: parseFloat(document.getElementById('editAmount').value||'0'),
        party: document.getElementById('editParty').value.trim(),
        date: rawDate,
        dateTS: new Date(rawDate),
        notes: document.getElementById('editNotes').value.trim()
        // keep createdBy fields intact
      };
      await updateDoc(ref, payload);
      modal.classList.add('hidden'); modal.classList.remove('flex');
    });

    document.getElementById('deleteEntry').addEventListener('click', async ()=>{
      const id = document.getElementById('editId').value;
      if(!confirm('Delete this entry?')) return;
      await deleteDoc(doc(db, 'entries', id));
      modal.classList.add('hidden'); modal.classList.remove('flex');
    });

    // Export CSV
    exportCsv.addEventListener('click', async ()=>{
      const snap = await getDocs(query(entriesCol, orderBy('createdAt','desc')));
      const rows = [['id','type','by','amount','party','date','notes','createdByEmail','createdAt']];
      snap.forEach(d=>{
        const e = d.data();
        const created = e.createdAt?.seconds ? new Date(e.createdAt.seconds*1000).toISOString() : '';
        const notes = (e.notes||'').replaceAll('\n',' ').replaceAll('\r',' ');
        rows.push([d.id,e.type,e.by,e.amount,e.party||'',e.date||'',notes,e.createdByEmail||'',created]);
      });
      const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'partner-ledger.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('date').value = todayISO();
  </script>
</body>
</html>
