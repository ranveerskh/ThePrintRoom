<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>The Print Room — Partner Ledger (Firebase)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          base: { bg:'#0f1628', card:'#18223c', ink:'#eef1ff', line:'#2a3357', acc:'#6c85ff', good:'#34d399', bad:'#fb7185' }
        },
        boxShadow: {
          soft: '0 8px 30px rgba(0,0,0,.25)'
        }
      }
    }
  }
</script>
<style>
  :root { color-scheme: dark; }
  body{
    background:#0f1628;color:#eef1ff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    padding-top: env(safe-area-inset-top); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);
  }
  .card{background:#18223c;border:1px solid #2a3357;border-radius:16px}
  .chip{border:1px solid #2a3357}
  .input{background:transparent;border:1px solid #2a3357;border-radius:12px;padding:.75rem;font-size:16px}
  .btn{background:#6c85ff;color:#000;font-weight:600;border-radius:12px;padding:.75rem 1rem}
  .btn.ghost{background:transparent;border:1px solid #2a3357;color:#eef1ff}
  .seg{border:1px solid #2a3357;border-radius:12px;overflow:hidden}
  .seg button{padding:.5rem .9rem}
  .seg .on{background:#2a3357}
  table{border-collapse:separate;border-spacing:0}
  th,td{border-bottom:1px solid #2a3357}
  tr:last-child td{border-bottom:none}
  .hidden{display:none}
  /* iOS keyboard-safe modal sheet */
  .sheet{position:fixed;inset:0;display:none}
  .sheet.on{display:flex}
  .sheet .panel{background:#18223c;border:1px solid #2a3357;border-radius:20px 20px 0 0;margin-top:auto;width:100%;
    max-height:92vh;overflow:auto;box-shadow:var(--shadow, 0 10px 50px rgba(0,0,0,.45));padding-bottom:env(safe-area-inset-bottom)}
  .tap-target{min-height:44px;min-width:44px}
</style>
</head>
<body class="min-h-screen">
  <!-- Minimal iOS-friendly Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-black/20 border-b border-[#2a3357]">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-[#6c85ff]/20 grid place-items-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16M4 12h10M4 17h16" stroke="#9db0ff" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
        <div class="font-bold">The Print Room — Ledger</div>
      </div>
      <button id="logoutBtn" class="btn ghost tap-target hidden">Logout</button>
    </div>
  </header>

  <!-- Auth Screen -->
  <section id="authScreen" class="max-w-md mx-auto p-6 mt-10 card">
    <h2 class="text-xl font-bold">Sign in</h2>
    <p class="text-sm text-white/70 mt-1">Partners only.</p>
    <form id="loginForm" class="grid gap-3 mt-4">
      <div class="grid gap-1">
        <label class="text-xs text-white/70">Email</label>
        <input id="email" type="email" class="input" placeholder="you@example.com" required />
      </div>
      <div class="grid gap-1">
        <label class="text-xs text-white/70">Password</label>
        <input id="password" type="password" class="input" placeholder="••••••••" required />
      </div>
      <button class="btn tap-target" type="submit">Sign in</button>
      <button id="resetBtn" class="btn ghost tap-target" type="button">Send password reset</button>
      <div id="authMsg" class="text-sm text-white/70"></div>
    </form>
  </section>

  <!-- App Screen -->
  <main id="appScreen" class="max-w-7xl mx-auto px-4 py-6 grid gap-6 hidden">
    <!-- Settlement + P/L summary -->
    <section class="grid lg:grid-cols-3 gap-6">
      <div class="card p-5 lg:col-span-3">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div>
            <div class="text-sm text-white/60">Settlement • <span id="activeRangeLabel">This month</span></div>
            <div id="settlementBox" class="mt-1 text-2xl font-extrabold"></div>
            <div id="settleMeta" class="text-xs text-white/60 mt-1"></div>
          </div>
          <div class="seg flex">
            <button class="tap-target" data-range="week">Week</button>
            <button class="tap-target on" data-range="month">Month</button>
            <button class="tap-target" data-range="year">Year</button>
            <button class="tap-target" data-range="life">All</button>
          </div>
        </div>
      </div>

      <div class="card p-5">
        <div class="text-sm text-white/60">Profit/Loss • This month</div>
        <div id="plMonth" class="mt-1 text-2xl font-extrabold"></div>
        <div id="plMonthMeta" class="text-xs text-white/60 mt-1"></div>
      </div>
      <div class="card p-5">
        <div class="text-sm text-white/60">Profit/Loss • This year</div>
        <div id="plYear" class="mt-1 text-2xl font-extrabold"></div>
        <div id="plYearMeta" class="text-xs text-white/60 mt-1"></div>
      </div>
      <div class="card p-5">
        <div class="text-sm text-white/60">Profit/Loss • Lifetime</div>
        <div id="plLife" class="mt-1 text-2xl font-extrabold"></div>
        <div id="plLifeMeta" class="text-xs text-white/60 mt-1"></div>
      </div>

      <div class="lg:col-span-3 flex items-center gap-3">
        <button id="openAdd" class="btn tap-target">Add entry</button>
      </div>
    </section>

    <!-- Entries List -->
    <section class="card p-5">
      <div class="flex flex-wrap items-center gap-2">
        <h2 class="text-lg font-bold mr-auto">Entries</h2>
        <input id="searchBox" class="input" placeholder="Search party, notes…" />
        <button id="exportCsv" class="btn ghost tap-target">Export CSV (filtered)</button>
      </div>
      <div class="overflow-auto mt-4">
        <table class="w-full text-sm">
          <thead class="text-white/60">
            <tr>
              <th class="text-left p-2">Date</th>
              <th class="text-left p-2">Type</th>
              <th class="text-left p-2">By</th>
              <th class="text-right p-2">Amount</th>
              <th class="text-left p-2">Party</th>
              <th class="text-left p-2">Notes</th>
              <th class="text-left p-2">Added by</th>
              <th class="text-right p-2">Owes Half</th>
              <th class="text-right p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="mt-3 text-xs text-white/60">Rule: Expense by X means the other owes X half. Sale by X means X owes the other half.</div>
    </section>
  </main>

  <!-- Add/Edit Sheet -->
  <div id="sheet" class="sheet items-stretch justify-center">
    <div class="panel">
      <div class="p-4 border-b border-[#2a3357] flex items-center justify-between sticky top-0 bg-[#18223c]">
        <div class="font-bold">Entry</div>
        <button id="closeSheet" class="btn ghost tap-target">Close</button>
      </div>
      <form id="entryForm" class="p-4 grid gap-3">
        <input type="hidden" id="editId" />
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Type</label>
          <select id="type" class="input" required>
            <option value="expense">Expense / Purchase</option>
            <option value="sale">Sale / Payment received</option>
          </select>
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Who made it</label>
          <select id="by" class="input" required>
            <option value="Ranveer">Ranveer</option>
            <option value="Aman">Aman</option>
          </select>
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Amount (CAD)</label>
          <input id="amount" type="number" step="0.01" min="0" class="input" placeholder="100" required />
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Sold to / Bought from</label>
          <input id="party" class="input" placeholder="Client or supplier name" />
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Date</label>
          <input id="date" type="date" class="input" />
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Notes</label>
          <textarea id="notes" class="input" rows="3" placeholder="Paper stock, job id, etc."></textarea>
        </div>
        <div class="flex items-center gap-2 pt-2">
          <button class="btn tap-target" type="submit">Save</button>
          <button id="deleteEntry" type="button" class="btn ghost tap-target hidden">Delete</button>
        </div>
        <div id="formMsg" class="text-sm text-white/70"></div>
      </form>
    </div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    // Firebase v9+ modular from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // --- Config (yours) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBALPTzgm1uiVCW4bwMJC2TPrWSsF-cCwQ",
      authDomain: "theprintroomlondon-6f586.firebaseapp.com",
      projectId: "theprintroomlondon-6f586",
      storageBucket: "theprintroomlondon-6f586.firebasestorage.app",
      messagingSenderId: "397446046987",
      appId: "1:397446046987:web:d9efe75b09d82ad6072e0e",
      measurementId: "G-D2Z6XF06Q6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    try { await enableIndexedDbPersistence(db); } catch(e) {}

    // UI refs
    const authScreen = document.getElementById('authScreen');
    const appScreen = document.getElementById('appScreen');
    const loginForm = document.getElementById('loginForm');
    const authMsg = document.getElementById('authMsg');
    const resetBtn = document.getElementById('resetBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const activeRangeLabel = document.getElementById('activeRangeLabel');
    const settlementBox = document.getElementById('settlementBox');
    const settleMeta = document.getElementById('settleMeta');

    const plMonth = document.getElementById('plMonth');
    const plMonthMeta = document.getElementById('plMonthMeta');
    const plYear = document.getElementById('plYear');
    const plYearMeta = document.getElementById('plYearMeta');
    const plLife = document.getElementById('plLife');
    const plLifeMeta = document.getElementById('plLifeMeta');

    const seg = document.querySelector('.seg');
    const openAdd = document.getElementById('openAdd');
    const sheet = document.getElementById('sheet');
    const closeSheet = document.getElementById('closeSheet');

    const entryForm = document.getElementById('entryForm');
    const formMsg = document.getElementById('formMsg');
    const deleteEntryBtn = document.getElementById('deleteEntry');
    const exportCsv = document.getElementById('exportCsv');
    const searchBox = document.getElementById('searchBox');
    const tableBody = document.getElementById('tableBody');

    // helpers
    const fmt = (n)=> Number(n||0).toLocaleString(undefined,{style:'currency',currency:'CAD'});
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const asDate = (val)=>{
      if(!val) return new Date(0);
      if(val.seconds && typeof val.seconds === 'number') return new Date(val.seconds*1000);
      if(val instanceof Date) return new Date(val.getTime());
      return new Date(val);
    };

    // week start Monday 00:00 local, inclusive
    function getStartOfWeek(d=new Date()){
      const t = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const day = t.getDay(); // 0 Sun .. 6 Sat
      const diff = (day + 6) % 7; // 0 for Mon
      t.setDate(t.getDate() - diff);
      return t;
    }
    function getStartOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function getStartOfYear(d=new Date()){ return new Date(d.getFullYear(), 0, 1); }

    let unsubscribe = null;
    let cache = [];
    let currentRange = 'month'; // default "This month"
    let editingId = null;

    function showApp(show){
      authScreen.classList.toggle('hidden', show);
      appScreen.classList.toggle('hidden', !show);
      logoutBtn.classList.toggle('hidden', !show);
    }

    onAuthStateChanged(auth, user => {
      if(user){
        showApp(true);
        attachListener();
      } else {
        showApp(false);
        if(unsubscribe){ unsubscribe(); unsubscribe = null; }
      }
    });

    // Auth handlers
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      authMsg.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try{ await signInWithEmailAndPassword(auth, email, password); }
      catch(err){ authMsg.textContent = err.message; }
    });
    resetBtn.addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      if(!email){ authMsg.textContent = 'Enter your email first.'; return; }
      try{ await sendPasswordResetEmail(auth, email); authMsg.textContent = 'Reset link sent.'; }
      catch(err){ authMsg.textContent = err.message; }
    });
    logoutBtn.addEventListener('click', ()=> signOut(auth));

    // Firestore
    const entriesCol = collection(db, 'entries');

    function attachListener(){
      if(unsubscribe) unsubscribe();
      // single index-free ordering, we will sort client-side by date later
      const q = query(entriesCol, orderBy('createdAt','desc'));
      unsubscribe = onSnapshot(q, snap => {
        cache = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        renderAll();
      }, err => console.error(err));
    }

    // Range switching (segmented control)
    seg.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-range]');
      if(!btn) return;
      seg.querySelectorAll('button').forEach(b=>b.classList.remove('on'));
      btn.classList.add('on');
      currentRange = btn.dataset.range;
      activeRangeLabel.textContent = rangeLabel(currentRange);
      renderAll();
    });

    function rangeLabel(r){
      return r==='week' ? 'This week' : r==='month' ? 'This month' : r==='year' ? 'This year' : 'All time';
    }

    // Sheet open/close
    openAdd.addEventListener('click', ()=>{
      editingId = null; // new entry
      deleteEntryBtn.classList.add('hidden');
      entryForm.reset();
      document.getElementById('date').value = todayISO();
      sheet.classList.add('on');
    });
    closeSheet.addEventListener('click', ()=> sheet.classList.remove('on'));

    // Create/Update entry
    entryForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      formMsg.textContent = '';
      const user = auth.currentUser;
      const rawDate = document.getElementById('date').value || todayISO();
      const payload = {
        type: document.getElementById('type').value,
        by: document.getElementById('by').value,
        amount: parseFloat(document.getElementById('amount').value||'0'),
        party: document.getElementById('party').value.trim(),
        date: rawDate,
        dateTS: new Date(rawDate),
        notes: document.getElementById('notes').value.trim()
      };
      if(!(payload.amount>0)) { formMsg.textContent = 'Enter a valid amount.'; return; }

      try{
        if(editingId){
          await updateDoc(doc(db,'entries',editingId), payload);
        } else {
          await addDoc(entriesCol, {
            ...payload,
            createdAt: serverTimestamp(),
            createdByEmail: user?.email || 'unknown',
            createdByUid: user?.uid || null
          });
        }
        sheet.classList.remove('on');
      }catch(err){ formMsg.textContent = err.message; }
    });

    deleteEntryBtn.addEventListener('click', async ()=>{
      if(!editingId) return;
      if(!confirm('Delete this entry?')) return;
      await deleteDoc(doc(db,'entries',editingId));
      sheet.classList.remove('on');
    });

    // Search re-render
    searchBox.addEventListener('input', renderTableAndSettlement);

    // Export CSV (filtered)
    exportCsv.addEventListener('click', ()=>{
      const rows = [['id','type','by','amount','party','date','notes','createdByEmail','createdAt']];
      const filtered = getFiltered(cache);
      filtered.forEach(e=>{
        const created = e.createdAt?.seconds ? new Date(e.createdAt.seconds*1000).toISOString() : '';
        const notes = (e.notes||'').replaceAll('\n',' ').replaceAll('\r',' ');
        rows.push([e.id,e.type,e.by,e.amount,e.party||'',e.date||'',notes,e.createdByEmail||'',created]);
      });
      const csv = rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `partner-ledger-${currentRange}.csv`; a.click();
      URL.revokeObjectURL(url);
    });

    // Compute helpers
    function computeSettlement(list){
      let balance=0, expR=0, expA=0, saleR=0, saleA=0;
      for(const e of list){
        const half = e.amount/2;
        if(e.type==='expense'){
          if(e.by==='Ranveer'){ balance += half; expR += e.amount; }
          else { balance -= half; expA += e.amount; }
        } else if(e.type==='sale'){
          if(e.by==='Ranveer'){ balance -= half; saleR += e.amount; }
          else { balance += half; saleA += e.amount; }
        }
      }
      return { balance, expR, expA, saleR, saleA };
    }
    function computePL(list){
      let expense=0, sales=0;
      for(const e of list){
        if(e.type==='expense') expense += e.amount;
        else if(e.type==='sale') sales += e.amount;
      }
      return { sales, expense, pl: sales - expense };
    }

    function getFiltered(list){
      // sort by date desc first
      const sorted = list.slice().sort((a,b)=> asDate(b.dateTS||b.date) - asDate(a.dateTS||a.date));
      const now = new Date();
      const startWeek = getStartOfWeek(now);
      const startMonth = getStartOfMonth(now);
      const startYear = getStartOfYear(now);
      const search = (searchBox.value||'').toLowerCase();

      return sorted.filter(e=>{
        const d = asDate(e.dateTS || e.date);
        if(currentRange==='week' && d < startWeek) return false;
        if(currentRange==='month' && d < startMonth) return false;
        if(currentRange==='year' && d < startYear) return false;
        if(search){
          const blob = `${e.type} ${e.by} ${e.party||''} ${e.notes||''} ${e.createdByEmail||''}`.toLowerCase();
          if(!blob.includes(search)) return false;
        }
        return true;
      });
    }

    function renderAll(){
      // Settlement uses filtered list (matches active range label)
      renderTableAndSettlement();
      // Profit/Loss tiles use fixed periods regardless of current filter
      const now = new Date();
      const monthList = cache.filter(e=> asDate(e.dateTS||e.date) >= getStartOfMonth(now));
      const yearList  = cache.filter(e=> asDate(e.dateTS||e.date) >= getStartOfYear(now));
      const lifeList  = cache.slice();

      const m = computePL(monthList);
      const y = computePL(yearList);
      const l = computePL(lifeList);

      renderPL(plMonth, plMonthMeta, m);
      renderPL(plYear,  plYearMeta,  y);
      renderPL(plLife,  plLifeMeta,  l);
    }

    function renderPL(target, metaEl, obj){
      target.textContent = `${obj.pl >= 0 ? '+' : ''}${fmt(obj.pl)}`;
      target.classList.toggle('text-base-good', obj.pl >= 0);
      target.classList.toggle('text-base-bad', obj.pl < 0);
      target.style.color = obj.pl >= 0 ? '#34d399' : '#fb7185';
      metaEl.textContent = `Sales ${fmt(obj.sales)} • Expenses ${fmt(obj.expense)}`;
    }

    function renderTableAndSettlement(){
      const entries = getFiltered(cache);
      const { balance, expR, expA, saleR, saleA } = computeSettlement(entries);

      // Settlement box
      if(balance > 0) settlementBox.textContent = `Aman owes Ranveer ${fmt(balance)}`;
      else if(balance < 0) settlementBox.textContent = `Ranveer owes Aman ${fmt(Math.abs(balance))}`;
      else settlementBox.textContent = 'You are square. 0.00 CAD';

      settleMeta.innerHTML = `
        <div>Total expenses — Ranveer: <b>${fmt(expR)}</b>, Aman: <b>${fmt(expA)}</b></div>
        <div>Total sales — Ranveer: <b>${fmt(saleR)}</b>, Aman: <b>${fmt(saleA)}</b></div>
        <div>Entries shown: <b>${entries.length}</b> of ${cache.length}</div>
      `;

      // Table
      tableBody.innerHTML = entries.map(e=>{
        const d = asDate(e.dateTS || e.date);
        const dateStr = isNaN(d) ? (e.date || '') : d.toISOString().slice(0,10);
        const half = e.amount/2;
        const owes = e.type==='expense'
          ? (e.by==='Ranveer' ? `Aman → ${fmt(half)}` : `Ranveer → ${fmt(half)}`)
          : (e.by==='Ranveer' ? `Ranveer → ${fmt(half)}` : `Aman → ${fmt(half)}`);
        return `<tr>
          <td class="p-2">${dateStr}</td>
          <td class="p-2 ${e.type==='expense'?'text-red-300':'text-green-300'}">${e.type}</td>
          <td class="p-2">${e.by}</td>
          <td class="p-2 text-right">${fmt(e.amount)}</td>
          <td class="p-2">${e.party||''}</td>
          <td class="p-2">${e.notes||''}</td>
          <td class="p-2">${e.createdByEmail||''}</td>
          <td class="p-2 text-right">${owes}</td>
          <td class="p-2 text-right"><button class="link tap-target" data-id="${e.id}" data-action="edit">Edit</button></td>
        </tr>`;
      }).join('');
    }

    // Row edit -> open sheet prefilled
    tableBody.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="edit"]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const e = cache.find(x=>x.id===id);
      if(!e) return;
      editingId = id;
      document.getElementById('type').value = e.type;
      document.getElementById('by').value = e.by;
      document.getElementById('amount').value = e.amount;
      document.getElementById('party').value = e.party || '';
      const d = asDate(e.dateTS || e.date);
      document.getElementById('date').value = isNaN(d) ? (e.date || '') : d.toISOString().slice(0,10);
      document.getElementById('notes').value = e.notes || '';
      deleteEntryBtn.classList.remove('hidden');
      sheet.classList.add('on');
    });

    // Init defaults
    document.getElementById('date').value = todayISO();
  </script>
</body>
</html>
