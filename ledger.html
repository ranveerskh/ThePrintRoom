<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>The Print Room — Partner Ledger (Firebase)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          base: { bg:'#0f1628', card:'#18223c', ink:'#eef1ff', line:'#2a3357', acc:'#6c85ff', good:'#34d399', bad:'#fb7185' }
        },
        boxShadow: {
          soft: '0 8px 30px rgba(0,0,0,.25)'
        }
      }
    }
  }
</script>
<style>
  :root { color-scheme: dark; }
  body{
    background:#0f1628;color:#eef1ff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    padding-top: env(safe-area-inset-top); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);
  }
  .card{background:#18223c;border:1px solid #2a3357;border-radius:16px}
  .chip{border:1px solid #2a3357;border-radius:999px;padding:.25rem .7rem;font-size:.75rem}
  .chip.on{background:#2a3357;}
  .input{background:transparent;border:1px solid #2a3357;border-radius:12px;padding:.75rem;font-size:16px}
  .btn{background:#6c85ff;color:#000;font-weight:600;border-radius:12px;padding:.75rem 1rem}
  .btn.ghost{background:transparent;border:1px solid #2a3357;color:#eef1ff}
  .seg{border:1px solid #2a3357;border-radius:12px;overflow:hidden}
  .seg button{padding:.5rem .9rem}
  .seg .on{background:#2a3357}
  table{border-collapse:separate;border-spacing:0}
  th,td{border-bottom:1px solid #2a3357}
  tr:last-child td{border-bottom:none}
  .hidden{display:none}
  /* iOS keyboard-safe modal sheet */
  .sheet{position:fixed;inset:0;display:none;z-index:40;}
  .sheet.on{display:flex}
  .sheet .panel{background:#18223c;border:1px solid #2a3357;border-radius:20px 20px 0 0;margin-top:auto;width:100%;
    max-height:92vh;overflow:auto;box-shadow:var(--shadow, 0 10px 50px rgba(0,0,0,.45));padding-bottom:env(safe-area-inset-bottom)}
  .tap-target{min-height:44px;min-width:44px}
</style>
</head>
<body class="min-h-screen">
  <!-- Minimal iOS-friendly Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-black/20 border-b border-[#2a3357]">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-[#6c85ff]/20 grid place-items-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16M4 12h10M4 17h16" stroke="#9db0ff" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
        <div class="font-bold">The Print Room — Ledger</div>
      </div>
      <button id="logoutBtn" class="btn ghost tap-target hidden">Logout</button>
    </div>
  </header>

  <!-- Auth Screen -->
  <section id="authScreen" class="max-w-md mx-auto p-6 mt-10 card">
    <h2 class="text-xl font-bold">Sign in</h2>
    <p class="text-sm text-white/70 mt-1">Partners only.</p>
    <form id="loginForm" class="grid gap-3 mt-4">
      <div class="grid gap-1">
        <label class="text-xs text-white/70">Email</label>
        <input id="email" type="email" class="input" placeholder="you@example.com" required />
      </div>
      <div class="grid gap-1">
        <label class="text-xs text-white/70">Password</label>
        <input id="password" type="password" class="input" placeholder="••••••••" required />
      </div>
      <button class="btn tap-target" type="submit">Sign in</button>
      <button id="resetBtn" class="btn ghost tap-target" type="button">Send password reset</button>
      <div id="authMsg" class="text-sm text-white/70"></div>
    </form>
  </section>

  <!-- App Screen -->
  <main id="appScreen" class="max-w-7xl mx-auto px-4 py-6 grid gap-6 hidden">
    <!-- Settlement + P/L summary -->
    <section class="grid lg:grid-cols-3 gap-6">
      <!-- Net settlement -->
      <div class="card p-5 lg:col-span-3">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div>
            <div class="text-sm text-white/60">Settlement • <span id="activeRangeLabel">This month</span></div>
            <div id="settlementBox" class="mt-1 text-2xl font-extrabold"></div>
            <div id="settleMeta" class="text-xs text-white/60 mt-1"></div>
          </div>
          <div class="seg flex">
            <button class="tap-target" data-range="week">Week</button>
            <button class="tap-target on" data-range="month">Month</button>
            <button class="tap-target" data-range="year">Year</button>
            <button class="tap-target" data-range="life">All</button>
          </div>
        </div>
      </div>

      <!-- P/L tiles -->
      <div class="card p-5">
        <div class="text-sm text-white/60">Profit/Loss • This month</div>
        <div id="plMonth" class="mt-1 text-2xl font-extrabold"></div>
        <div id="plMonthMeta" class="text-xs text-white/60 mt-1"></div>
      </div>
      <div class="card p-5">
        <div class="text-sm text-white/60">Profit/Loss • This year</div>
        <div id="plYear" class="mt-1 text-2xl font-extrabold"></div>
        <div id="plYearMeta" class="text-xs text-white/60 mt-1"></div>
      </div>
      <div class="card p-5">
        <div class="text-sm text-white/60">Profit/Loss • Lifetime</div>
        <div id="plLife" class="mt-1 text-2xl font-extrabold"></div>
        <div id="plLifeMeta" class="text-xs text-white/60 mt-1"></div>
      </div>

      <!-- Pending payments summary -->
      <div class="card p-5 lg:col-span-3">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div>
            <div class="text-sm text-white/60">Pending customer payments</div>
            <div id="pendingTotal" class="mt-1 text-xl font-bold"></div>
            <div id="pendingMeta" class="text-xs text-white/60 mt-1"></div>
          </div>
        </div>
      </div>

      <!-- Add entry button -->
      <div class="lg:col-span-3 flex items-center gap-3">
        <button id="openAdd" class="btn tap-target">Add entry</button>
      </div>
    </section>

    <!-- Entries List -->
    <section class="card p-5">
      <!-- Header row -->
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <h2 class="text-lg font-bold mr-auto">Entries</h2>
        <button id="exportCsv" class="btn ghost tap-target text-sm">Export CSV (filtered)</button>
      </div>

      <!-- Search row -->
      <div class="mb-3">
        <input id="searchBox" class="input w-full" placeholder="Search type, party, notes…" />
      </div>

      <!-- Filter chips -->
      <div class="flex flex-wrap gap-3 text-xs">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-white/50">Type:</span>
          <button class="chip tap-target filter-type on" data-filter-type="all">All</button>
          <button class="chip tap-target filter-type" data-filter-type="expense">Expenses</button>
          <button class="chip tap-target filter-type" data-filter-type="sale">Sales</button>
          <button class="chip tap-target filter-type" data-filter-type="settlement">Settlements</button>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-white/50">By:</span>
          <button class="chip tap-target filter-by on" data-filter-by="both">Both</button>
          <button class="chip tap-target filter-by" data-filter-by="Ranveer">Ranveer</button>
          <button class="chip tap-target filter-by" data-filter-by="Aman">Aman</button>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-white/50">Status:</span>
          <button class="chip tap-target filter-status on" data-filter-status="all">All</button>
          <button class="chip tap-target filter-status" data-filter-status="paid">Paid</button>
          <button class="chip tap-target filter-status" data-filter-status="pending">Pending</button>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-auto mt-4">
        <table class="w-full text-sm">
          <thead class="text-white/60">
            <tr>
              <th class="text-left p-2">Date</th>
              <th class="text-left p-2">Type</th>
              <th class="text-left p-2">By</th>
              <th class="text-right p-2">Amount</th>
              <th class="text-left p-2">Party</th>
              <th class="text-left p-2">Notes</th>
              <th class="text-left p-2">Added by</th>
              <th class="text-right p-2">Owes Half</th>
              <th class="text-right p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="mt-3 text-xs text-white/60">
        Rule: Expense by X means the other owes X half. Sale by X means X owes the other half. Settlement payments adjust only the partner balance.
      </div>
    </section>
  </main>

  <!-- Floating Add button (mobile) -->
  <button id="openAddFab" class="fixed bottom-5 right-5 md:hidden btn rounded-full shadow-soft tap-target hidden z-40">
    +
  </button>

  <!-- Add/Edit Sheet -->
  <div id="sheet" class="sheet items-stretch justify-center">
    <div class="panel">
      <div class="p-4 border-b border-[#2a3357] flex items-center justify-between sticky top-0 bg-[#18223c]">
        <div class="font-bold">Entry</div>
        <button id="closeSheet" class="btn ghost tap-target">Close</button>
      </div>
      <form id="entryForm" class="p-4 grid gap-3">
        <input type="hidden" id="editId" />
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Type</label>
          <select id="type" class="input" required>
            <option value="expense">Expense / Purchase</option>
            <option value="sale">Sale / Payment received</option>
            <option value="settlement">Partner settlement payment</option>
          </select>
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Who made it</label>
          <select id="by" class="input" required>
            <option value="Ranveer">Ranveer</option>
            <option value="Aman">Aman</option>
          </select>
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Amount (CAD)</label>
          <input id="amount" type="number" step="0.01" min="0" class="input" placeholder="100" required />
        </div>

        <!-- Party/Supplier -->
        <div class="grid gap-1" id="partyGroup">
          <label class="text-xs text-white/70" id="partyLabel">Sold to / Bought from</label>
          <input id="party" class="input" placeholder="Client or supplier name" />
          <datalist id="supplierList"></datalist>
        </div>

        <!-- Sale status -->
        <div class="grid gap-1" id="statusGroup">
          <label class="text-xs text-white/70">Payment status (for sales)</label>
          <select id="status" class="input">
            <option value="paid">Paid</option>
            <option value="pending">Pending</option>
          </select>
        </div>

        <div class="grid gap-1">
          <label class="text-xs text-white/70">Date</label>
          <input id="date" type="date" class="input" />
        </div>

        <!-- Job / Project -->
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Job / Project ID (optional)</label>
          <input id="jobId" class="input" placeholder="e.g. Backdrop-2025-01-15" />
        </div>

        <!-- Category -->
        <div class="grid gap-1">
          <label class="text-xs text-white/70">Category (optional)</label>
          <select id="entryCategory" class="input">
            <option value="">Uncategorized</option>
            <option value="materials">Materials</option>
            <option value="tools">Tools</option>
            <option value="printing">Printing</option>
            <option value="decor">Decor</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="grid gap-1">
          <label class="text-xs text-white/70">Notes</label>
          <textarea id="notes" class="input" rows="3" placeholder="Paper stock, job id, etc."></textarea>
        </div>
        <div class="flex items-center gap-2 pt-2">
          <button class="btn tap-target" type="submit">Save</button>
          <button id="deleteEntry" type="button" class="btn ghost tap-target hidden">Delete</button>
        </div>
        <div id="formMsg" class="text-sm text-white/70"></div>
      </form>
    </div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    // Firebase v9+ modular from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // --- Config (yours) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBALPTzgm1uiVCW4bwMJC2TPrWSsF-cCwQ",
      authDomain: "theprintroomlondon-6f586.firebaseapp.com",
      projectId: "theprintroomlondon-6f586",
      storageBucket: "theprintroomlondon-6f586.firebasestorage.app",
      messagingSenderId: "397446046987",
      appId: "1:397446046987:web:d9efe75b09d82ad6072e0e",
      measurementId: "G-D2Z6XF06Q6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    try { await enableIndexedDbPersistence(db); } catch(e) {}

    // UI refs
    const authScreen = document.getElementById('authScreen');
    const appScreen = document.getElementById('appScreen');
    const loginForm = document.getElementById('loginForm');
    const authMsg = document.getElementById('authMsg');
    const resetBtn = document.getElementById('resetBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const activeRangeLabel = document.getElementById('activeRangeLabel');
    const settlementBox = document.getElementById('settlementBox');
    const settleMeta = document.getElementById('settleMeta');

    const plMonth = document.getElementById('plMonth');
    const plMonthMeta = document.getElementById('plMonthMeta');
    const plYear = document.getElementById('plYear');
    const plYearMeta = document.getElementById('plYearMeta');
    const plLife = document.getElementById('plLife');
    const plLifeMeta = document.getElementById('plLifeMeta');

    const pendingTotal = document.getElementById('pendingTotal');
    const pendingMeta = document.getElementById('pendingMeta');

    const seg = document.querySelector('.seg');
    const openAdd = document.getElementById('openAdd');
    const openAddFab = document.getElementById('openAddFab');
    const sheet = document.getElementById('sheet');
    const closeSheet = document.getElementById('closeSheet');

    const entryForm = document.getElementById('entryForm');
    const formMsg = document.getElementById('formMsg');
    const deleteEntryBtn = document.getElementById('deleteEntry');
    const exportCsv = document.getElementById('exportCsv');
    const searchBox = document.getElementById('searchBox');
    const tableBody = document.getElementById('tableBody');
    const supplierListEl = document.getElementById('supplierList');

    const typeSelect = document.getElementById('type');
    const partyGroup = document.getElementById('partyGroup');
    const partyLabel = document.getElementById('partyLabel');
    const partyInput = document.getElementById('party');
    const statusGroup = document.getElementById('statusGroup');
    const statusSelect = document.getElementById('status');
    const jobIdInput = document.getElementById('jobId');
    const entryCategorySelect = document.getElementById('entryCategory');

    // helpers
    const fmt = (n)=> Number(n||0).toLocaleString(undefined,{style:'currency',currency:'CAD'});
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const asDate = (val)=>{
      if(!val) return new Date(0);
      if(val.seconds && typeof val.seconds === 'number') return new Date(val.seconds*1000);
      if(val instanceof Date) return new Date(val.getTime());
      return new Date(val);
    };

    // week start Monday 00:00 local, inclusive
    function getStartOfWeek(d=new Date()){
      const t = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const day = t.getDay(); // 0 Sun .. 6 Sat
      const diff = (day + 6) % 7; // 0 for Mon
      t.setDate(t.getDate() - diff);
      return t;
    }
    function getStartOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function getStartOfYear(d=new Date()){ return new Date(d.getFullYear(), 0, 1); }

    let unsubscribe = null;
    let cache = [];
    let currentRange = 'month'; // default "This month"
    let editingId = null;

    // extra filters
    let filterType = 'all';   // all | expense | sale | settlement
    let filterBy = 'both';    // both | Ranveer | Aman
    let filterStatus = 'all'; // all | paid | pending

    function showApp(show){
      authScreen.classList.toggle('hidden', show);
      appScreen.classList.toggle('hidden', !show);
      logoutBtn.classList.toggle('hidden', !show);
      openAddFab.classList.toggle('hidden', !show);
    }

    onAuthStateChanged(auth, user => {
      if(user){
        showApp(true);
        attachListener();
      } else {
        showApp(false);
        if(unsubscribe){ unsubscribe(); unsubscribe = null; }
      }
    });

    // Auth handlers
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      authMsg.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try{
        await signInWithEmailAndPassword(auth, email, password);
      } catch(err){
        authMsg.textContent = 'Sign-in failed. Check email or password.';
        console.error(err);
      }
    });

    resetBtn.addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      if(!email){ authMsg.textContent = 'Enter your email first.'; return; }
      try{
        await sendPasswordResetEmail(auth, email);
        authMsg.textContent = 'Reset link sent.';
      } catch(err){
        authMsg.textContent = 'Could not send reset link.';
        console.error(err);
      }
    });

    logoutBtn.addEventListener('click', ()=> signOut(auth));

    // Firestore
    const entriesCol = collection(db, 'entries');

    function attachListener(){
      if(unsubscribe) unsubscribe();
      // single index-free ordering, we will sort client-side by date later
      const q = query(entriesCol, orderBy('createdAt','desc'));
      unsubscribe = onSnapshot(q, snap => {
        cache = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        renderAll();
      }, err => console.error(err));
    }

    // Range switching (segmented control)
    seg.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-range]');
      if(!btn) return;
      seg.querySelectorAll('button').forEach(b=>b.classList.remove('on'));
      btn.classList.add('on');
      currentRange = btn.dataset.range;
      activeRangeLabel.textContent = rangeLabel(currentRange);
      renderAll();
    });

    function rangeLabel(r){
      return r==='week' ? 'This week' : r==='month' ? 'This month' : r==='year' ? 'This year' : 'All time';
    }

    // Open sheet for new entry
    function openNewEntrySheet(){
      editingId = null;
      deleteEntryBtn.classList.add('hidden');
      entryForm.reset();
      document.getElementById('date').value = todayISO();
      typeSelect.value = 'expense';
      statusSelect.value = 'paid';
      updateFormForType('expense');
      formMsg.textContent = '';
      sheet.classList.add('on');
    }

    // Sheet open/close
    openAdd.addEventListener('click', openNewEntrySheet);
    openAddFab.addEventListener('click', openNewEntrySheet);
    closeSheet.addEventListener('click', ()=> sheet.classList.remove('on'));

    // Type-dependent form behavior
    function updateFormForType(t){
      if(t === 'expense'){
        partyGroup.classList.remove('hidden');
        statusGroup.classList.add('hidden');
        partyLabel.textContent = 'Bought from (supplier)';
        partyInput.setAttribute('list','supplierList');
      } else if(t === 'sale'){
        partyGroup.classList.remove('hidden');
        statusGroup.classList.remove('hidden');
        partyLabel.textContent = 'Sold to (customer)';
        partyInput.removeAttribute('list');
      } else { // settlement
        partyGroup.classList.add('hidden');
        statusGroup.classList.add('hidden');
      }
    }

    typeSelect.addEventListener('change', (e)=>{
      updateFormForType(e.target.value);
    });

    // Create/Update entry
    entryForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      formMsg.textContent = '';
      const user = auth.currentUser;
      const rawDate = document.getElementById('date').value || todayISO();
      const typeVal = typeSelect.value;
      const amountVal = parseFloat(document.getElementById('amount').value||'0');
      if(!(amountVal > 0)) { formMsg.textContent = 'Enter a valid amount.'; return; }

      const payloadBase = {
        type: typeVal,
        by: document.getElementById('by').value,
        amount: amountVal,
        party: typeVal === 'settlement' ? '' : (partyInput.value.trim() || ''),
        date: rawDate,
        dateTS: new Date(rawDate),
        notes: document.getElementById('notes').value.trim(),
        jobId: jobIdInput.value.trim() || undefined,
        entryCategory: entryCategorySelect.value || undefined
      };

      if(typeVal === 'sale'){
        payloadBase.status = statusSelect.value || 'paid';
      }

      try{
        if(editingId){
          await updateDoc(doc(db,'entries',editingId), {
            ...payloadBase,
            updatedAt: serverTimestamp(),
            updatedByEmail: user?.email || 'unknown'
          });
        } else {
          await addDoc(entriesCol, {
            ...payloadBase,
            createdAt: serverTimestamp(),
            createdByEmail: user?.email || 'unknown',
            createdByUid: user?.uid || null
          });
        }
        sheet.classList.remove('on');
      }catch(err){
        formMsg.textContent = 'Error saving entry.';
        console.error(err);
      }
    });

    deleteEntryBtn.addEventListener('click', async ()=>{
      if(!editingId) return;
      if(!confirm('Delete this entry?')) return;
      try{
        await deleteDoc(doc(db,'entries',editingId));
        sheet.classList.remove('on');
      } catch(err){
        console.error(err);
      }
    });

    // Search re-render
    searchBox.addEventListener('input', renderTableAndSettlement);

    // Filter chips
    function setupFilterGroup(selector, typeKey){
      const buttons = document.querySelectorAll(selector);
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          buttons.forEach(b=>b.classList.remove('on'));
          btn.classList.add('on');
          const val = btn.getAttribute(typeKey);
          if(typeKey === 'data-filter-type') filterType = val;
          if(typeKey === 'data-filter-by') filterBy = val;
          if(typeKey === 'data-filter-status') filterStatus = val;
          renderTableAndSettlement();
        });
      });
    }

    setupFilterGroup('.filter-type','data-filter-type');
    setupFilterGroup('.filter-by','data-filter-by');
    setupFilterGroup('.filter-status','data-filter-status');

    // Export CSV (filtered)
    exportCsv.addEventListener('click', ()=>{
      const rows = [['id','type','by','amount','party','date','notes','status','jobId','entryCategory','createdByEmail','createdAt','updatedByEmail','updatedAt']];
      const filtered = getFiltered(cache);
      filtered.forEach(e=>{
        const created = e.createdAt?.seconds ? new Date(e.createdAt.seconds*1000).toISOString() : '';
        const updated = e.updatedAt?.seconds ? new Date(e.updatedAt.seconds*1000).toISOString() : '';
        const notes = (e.notes||'').replaceAll('\n',' ').replaceAll('\r',' ');
        const status = e.type === 'sale' ? (e.status || 'paid') : '';
        rows.push([
          e.id,
          e.type || '',
          e.by || '',
          e.amount || 0,
          e.party || '',
          e.date || '',
          notes,
          status,
          e.jobId || '',
          e.entryCategory || '',
          e.createdByEmail || '',
          created,
          e.updatedByEmail || '',
          updated
        ]);
      });
      const csv = rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `partner-ledger-${currentRange}.csv`; a.click();
      URL.revokeObjectURL(url);
    });

    // Compute helpers
    function computeSettlement(list){
      let balance=0, expR=0, expA=0, saleR=0, saleA=0;
      for(const e of list){
        const amt = Number(e.amount || 0);
        const half = amt/2;
        if(e.type==='expense'){
          if(e.by==='Ranveer'){ balance += half; expR += amt; }
          else if(e.by==='Aman'){ balance -= half; expA += amt; }
        } else if(e.type==='sale'){
          if(e.by==='Ranveer'){ balance -= half; saleR += amt; }
          else if(e.by==='Aman'){ balance += half; saleA += amt; }
        } else if(e.type==='settlement'){
          // Partner settlement payment
          if(e.by==='Ranveer'){ balance -= amt; }
          else if(e.by==='Aman'){ balance += amt; }
        }
      }
      return { balance, expR, expA, saleR, saleA };
    }

    function computePL(list){
      let expense=0, sales=0;
      for(const e of list){
        const amt = Number(e.amount || 0);
        if(e.type==='expense') expense += amt;
        else if(e.type==='sale') sales += amt;
        // settlements ignored for P/L
      }
      return { sales, expense, pl: sales - expense };
    }

    function getFiltered(list){
      // sort by date desc first
      const sorted = list.slice().sort((a,b)=> asDate(b.dateTS||b.date) - asDate(a.dateTS||a.date));
      const now = new Date();
      const startWeek = getStartOfWeek(now);
      const startMonth = getStartOfMonth(now);
      const startYear = getStartOfYear(now);
      const search = (searchBox.value||'').toLowerCase();

      return sorted.filter(e=>{
        const d = asDate(e.dateTS || e.date);
        if(currentRange==='week' && d < startWeek) return false;
        if(currentRange==='month' && d < startMonth) return false;
        if(currentRange==='year' && d < startYear) return false;

        if(filterType !== 'all' && (e.type !== filterType)) return false;

        if(filterBy === 'Ranveer' && e.by !== 'Ranveer') return false;
        if(filterBy === 'Aman' && e.by !== 'Aman') return false;

        if(filterStatus !== 'all'){
          if(e.type !== 'sale') return false;
          const status = e.status || 'paid';
          if(status !== filterStatus) return false;
        }

        if(search){
          const blob = `${e.type||''} ${e.by||''} ${e.party||''} ${e.notes||''} ${e.createdByEmail||''} ${e.jobId||''} ${e.entryCategory||''}`.toLowerCase();
          if(!blob.includes(search)) return false;
        }
        return true;
      });
    }

    function refreshSuppliers(){
      if(!supplierListEl) return;
      const names = Array.from(new Set(
        cache
          .filter(e=> e.type==='expense' && e.party)
          .map(e=> String(e.party).trim())
          .filter(Boolean)
      )).sort((a,b)=> a.localeCompare(b));
      supplierListEl.innerHTML = names.map(name=>`<option value="${name}"></option>`).join('');
    }

    function renderAll(){
      // Settlement & table use filtered list (matches active range label & filters)
      renderTableAndSettlement();

      // Profit/Loss tiles use fixed periods regardless of current filter
      const now = new Date();
      const monthList = cache.filter(e=> asDate(e.dateTS||e.date) >= getStartOfMonth(now));
      const yearList  = cache.filter(e=> asDate(e.dateTS||e.date) >= getStartOfYear(now));
      const lifeList  = cache.slice();

      const m = computePL(monthList);
      const y = computePL(yearList);
      const l = computePL(lifeList);

      renderPL(plMonth, plMonthMeta, m);
      renderPL(plYear,  plYearMeta,  y);
      renderPL(plLife,  plLifeMeta,  l);

      // Pending payments (all-time, regardless of filters)
      const pendingSales = cache.filter(e=> e.type==='sale' && (e.status || 'paid') === 'pending');
      const pendingAmount = pendingSales.reduce((sum,e)=> sum + (Number(e.amount||0)), 0);
      pendingTotal.textContent = fmt(pendingAmount);
      pendingMeta.textContent = pendingSales.length
        ? `${pendingSales.length} pending sale${pendingSales.length>1?'s':''}`
        : 'No pending payments.';

      // Suppliers list
      refreshSuppliers();
    }

    function renderPL(target, metaEl, obj){
      target.textContent = `${obj.pl >= 0 ? '+' : ''}${fmt(obj.pl)}`;
      target.style.color = obj.pl >= 0 ? '#34d399' : '#fb7185';
      metaEl.textContent = `Sales ${fmt(obj.sales)} • Expenses ${fmt(obj.expense)}`;
    }

    function renderTableAndSettlement(){
      const entries = getFiltered(cache);
      const { balance, expR, expA, saleR, saleA } = computeSettlement(entries);

      // Settlement box
      if(balance > 0){
        settlementBox.textContent = `Aman owes Ranveer ${fmt(balance)}`;
        settlementBox.style.color = '#34d399';
      } else if(balance < 0){
        settlementBox.textContent = `Ranveer owes Aman ${fmt(Math.abs(balance))}`;
        settlementBox.style.color = '#fb7185';
      } else {
        settlementBox.textContent = 'You are square. 0.00 CAD';
        settlementBox.style.color = '#eef1ff';
      }

      settleMeta.innerHTML = `
        <div>Total expenses — Ranveer: <b>${fmt(expR)}</b>, Aman: <b>${fmt(expA)}</b></div>
        <div>Total sales — Ranveer: <b>${fmt(saleR)}</b>, Aman: <b>${fmt(saleA)}</b></div>
        <div>Entries shown: <b>${entries.length}</b> of ${cache.length}</div>
      `;

      // Table
      tableBody.innerHTML = entries.map(e=>{
        const d = asDate(e.dateTS || e.date);
        const dateStr = isNaN(d) ? (e.date || '') : d.toISOString().slice(0,10);
        const amt = Number(e.amount || 0);
        const half = amt/2;

        let owes = '';
        if(e.type === 'expense'){
          owes = e.by==='Ranveer'
            ? `Aman → ${fmt(half)}`
            : `Ranveer → ${fmt(half)}`;
        } else if(e.type === 'sale'){
          owes = e.by==='Ranveer'
            ? `Ranveer → ${fmt(half)}`
            : `Aman → ${fmt(half)}`;
        } else if(e.type === 'settlement'){
          owes = 'Settlement';
        }

        const status = e.type === 'sale' ? (e.status || 'paid') : null;
        let typeLabel = e.type || '';
        if(e.type === 'expense') typeLabel = 'expense';
        if(e.type === 'sale') typeLabel = 'sale';
        if(e.type === 'settlement') typeLabel = 'settlement';

        const typeColorClass = e.type==='expense'
          ? 'text-red-300'
          : e.type==='sale'
            ? 'text-green-300'
            : 'text-blue-300';

        let statusBadge = '';
        if(status === 'pending'){
          statusBadge = '<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-300">Pending</span>';
        } else if(status === 'paid'){
          statusBadge = '<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/15 text-emerald-300">Paid</span>';
        }

        return `<tr>
          <td class="p-2">${dateStr}</td>
          <td class="p-2 ${typeColorClass}">${typeLabel}${status ? statusBadge : ''}</td>
          <td class="p-2">${e.by || ''}</td>
          <td class="p-2 text-right">${fmt(amt)}</td>
          <td class="p-2">${e.party || ''}</td>
          <td class="p-2">${e.notes || ''}</td>
          <td class="p-2">${e.createdByEmail || ''}</td>
          <td class="p-2 text-right">${owes}</td>
          <td class="p-2 text-right">
            <button class="link tap-target text-indigo-300 underline text-xs" data-id="${e.id}" data-action="edit">Edit</button>
          </td>
        </tr>`;
      }).join('');
    }

    // Row edit -> open sheet prefilled
    tableBody.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="edit"]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const e = cache.find(x=>x.id===id);
      if(!e) return;
      editingId = id;

      typeSelect.value = e.type || 'expense';
      document.getElementById('by').value = e.by || 'Ranveer';
      document.getElementById('amount').value = e.amount || 0;
      partyInput.value = e.party || '';
      const d = asDate(e.dateTS || e.date);
      document.getElementById('date').value = isNaN(d) ? (e.date || '') : d.toISOString().slice(0,10);
      document.getElementById('notes').value = e.notes || '';
      jobIdInput.value = e.jobId || '';
      entryCategorySelect.value = e.entryCategory || '';

      if(e.type === 'sale'){
        statusSelect.value = e.status || 'paid';
      } else {
        statusSelect.value = 'paid';
      }

      updateFormForType(typeSelect.value);
      deleteEntryBtn.classList.remove('hidden');
      formMsg.textContent = '';
      sheet.classList.add('on');
    });

    // Init defaults
    document.getElementById('date').value = todayISO();
    statusSelect.value = 'paid';
    updateFormForType('expense');
  </script>
</body>
</html>